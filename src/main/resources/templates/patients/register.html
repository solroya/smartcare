<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>환자 접수</title>
</head>
<body>
<h1>환자 접수</h1>

<form th:onsubmit="return openSearchPopup()">
    <label for="memberName">이름:</label>
    <input type="text" id="memberName" name="memberName" required>

    <label for="memberBirthday">생년월일:</label>
    <input type="date" id="memberBirthday" name="memberBirthday" required>

    <button type="submit">검색</button>
</form>

<!-- 선택된 회원 정보 출력 -->
<div id="selectedMemberInfo" style="margin-top: 20px; display: none;">
    <h3>선택된 회원 정보:</h3>
    <p>번호: <span id="selectedMemberNo"></span></p>
    <p>이름: <span id="selectedMemberName"></span></p>
    <p>생년월일: <span id="selectedMemberBirthday"></span></p>
    <p>이메일: <span id="selectedMemberEmail"></span></p>
    <p>전화번호: <span id="selectedMemberPhoneNumber"></span></p>
    <input type="hidden" id="selectedMemberId" name="selectedMemberId">
</div>

<div>
    <!-- 진료과 선택 -->
    <label for="department">진료과</label>
    <select id="department" name="department" required onchange="loadDoctors(this.value)">
        <option value="">진료과 선택</option>
        <option value="INTERNAL_MEDICINE">내과</option>
        <option value="SURGERY">외과</option>
        <option value="PSYCHIATRY">정신과</option>
    </select>
    <br>
    <!-- 의사 선택 -->
    <label for="doctor">의사</label>
    <select id="doctor" name="doctor" required>
        <option value="">의사 선택</option>
    </select>
    <div id="loading" style="display: none;">의사 정보를 불러오는 중...</div>
    <div id="error" style="color: red; display: none;">의사 정보를 불러오는 데 실패했습니다.</div>
    <br>
</div>

<div>
    <form id="registrationForm" th:action="@{/erp/appointments/new}" method="post">
        <input type="hidden" name="memberNo" id="memberNo">
        <input type="hidden" name="employeeNo" id="employeeNo">
<!--        <input type="hidden" name="doctorId" id="doctorId">
        <input type="hidden" name="doctorName" id="doctorName">-->
        <button type="submit" id="registerButton" disabled>진료 등록</button>
    </form>
    <button onclick="resetSelection()">초기화</button>
    <button th:href="@{/}" onclick="window.location='/'; return false;">메인으로</button>
    <button th:href="@{/patients/new}" onclick="window.location='/patients/new'; return false;">환자등록</button>
</div>

<script>
    function openSearchPopup() {
        const name = document.getElementById('memberName').value;
        const birthday = document.getElementById('memberBirthday').value;

        if (!name || !birthday) {
            alert("이름과 생년월일을 입력해주세요.");
            return false;
        }

        const popup = window.open(`/erp/patients/search?memberName=${name}&memberBirthday=${birthday}`, 'popup', 'width=800,height=600');
        popup.focus();
        return false; // 폼 제출 방지
    }

    function setMemberData(memberNo, memberName, memberBirthday, memberEmail, memberPhoneNumber) {
        const infoDiv = document.getElementById('selectedMemberInfo');
        const registerButton = document.getElementById('registerButton');

        // 선택된 회원 정보 설정
        document.getElementById('selectedMemberId').value = memberNo;
        document.getElementById('selectedMemberNo').textContent = memberNo;
        document.getElementById('selectedMemberName').textContent = memberName;
        document.getElementById('selectedMemberBirthday').textContent = memberBirthday;
        document.getElementById('selectedMemberEmail').textContent = memberEmail;
        document.getElementById('selectedMemberPhoneNumber').textContent = memberPhoneNumber;

        // 진료 등록 버튼 활성화 및 회원 정보 표시
        document.getElementById('memberNo').value = memberNo; // 등록 폼에 memberNo 설정
        registerButton.disabled = false; // 버튼 활성화
        infoDiv.style.display = 'block'; // 회원 정보 표시
    }

    function resetSelection() {
        const infoDiv = document.getElementById('selectedMemberInfo');
        const registerButton = document.getElementById('registerButton');

        // 선택된 회원 정보 초기화
        document.getElementById('selectedMemberId').value = '';
        document.getElementById('selectedMemberNo').textContent = '';
        document.getElementById('selectedMemberName').textContent = '';
        document.getElementById('selectedMemberBirthday').textContent = '';
        document.getElementById('selectedMemberEmail').textContent = '';
        document.getElementById('selectedMemberPhoneNumber').textContent = '';

        // 진료 등록 버튼 비활성화 및 회원 정보 숨김
        registerButton.disabled = true; // 버튼 비활성화
        infoDiv.style.display = 'none'; // 회원 정보 숨김
    }

    function loadDoctors(department) {
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const doctorSelect = document.getElementById('doctor');

        // 초기화
        doctorSelect.innerHTML = '<option value="">의사 선택</option>';
        loadingDiv.style.display = 'block';
        errorDiv.style.display = 'none';

        // AJAX로 의사 목록 불러오기
        fetch(`/erp/patients/doctors?department=${department}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                loadingDiv.style.display = 'none';
                if (data.length === 0) {
                    errorDiv.textContent = '해당 진료과에 의사가 없습니다.';
                    errorDiv.style.display = 'block';
                    return;
                }
                data.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.employeeNo;
                    option.textContent = doctor.employeeName;
                    doctorSelect.appendChild(option);
                });
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = '의사 정보를 불러오는 중 오류가 발생했습니다.';
                errorDiv.style.display = 'block';
                console.error('Error loading doctors:', error);
            });

        // 불러온 의사 정보 저장
        document.getElementById('doctor').addEventListener('change', function() {
            const selectedDoctor = this.options[this.selectedIndex];
            document.getElementById('employeeNo').value = selectedDoctor.value; // employeeNo 설정
        });
    }
</script>
</body>
</html>
